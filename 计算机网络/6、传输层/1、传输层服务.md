> 传输层
>
> 传输层架构在网络层提供的服务之上，把数据传递服务从两台计算机之间扩展到两台计算机进程之间。
>
> **传输服务：**使两台地理位置不同的计算机进程之间的通信，就像同一台计算机不同进程之间通信一样简单。
>
> **服务原语：**传输层为上层提供抽象模式，使得上层可以便捷的使用传输层的功能。而不用关注实现的细节。

> 传输服务
>
> 传输层的最终目标是利用网络层提供的服务，为应用层提供高效的、可靠的数据传输服务。在主机中完成这个功能的代码叫传输实体。
>
> 传输实体：它可以实现在主机的不同位置，可能在操作系统内核、可能以链接库的形式绑定到网络应用中，或者以一个独立的用户进程运行，甚至运行在网络接口卡(NIC)上。
>
> 
>
> 为什么要区分传输层和网络层
>
> 1、传输层代码基本只运行在用户主机上，网络层代码重要运行在运营商的路由器上。
>
> 2、用户对未来层没有真正的控制权。他们不拥有路由器也不能用更好的路由器或者在数据链路层上用更好的错误处理机制来解决服务太差的问题。
>
> 3、传输层的连接可以弥补网络层连接中断的缺陷，重新发起连接。
>
> 4、传输层屏蔽网络层不同协议的区别，使得上层应用只需要调用传输层原语就能实现对于的功能，不必关心在不同网络协议上如何实现。
>
> 
>
> 许多人习惯于将网络分两部分：1\~4层位一部分，4\~8层位一部分。前4层可以看作**传输服务提供者**，后4层可以看作**传输服务用户**

> 传输服务原语（简单的传输服务接口）
>
> 为了允许用户访问传输协议，传输层必须位应用程序提供一些操作，就是提供传一个输服务接口。
>
> LISTEN：侦听，主机创建进程并侦听某个端口，直到某本进程试图连接。
>
> CONNECT：主动尝试建立一个连接
>
> SEND：发送消息
>
> RECEIVE：阻塞。直到一个DATA包到达
>
> DISCONNECT：释放连接
>
> 
>
> 实例：
>
> 1、服务器使用LISTEN原语，阻塞并持续侦听
>
> 2、客户端使用CONNECT原语发起连接
>
> 3、服务器收到CONNECT REQUEST，若服务器进程处于LISTEN状态则解除阻塞，回复确认。双方连接建立
>
> 4、建立连接后双方即可用SEND、RECEIVE原语进行数据的发送和接收。
>
> 5、使用DISCONNECT原语解除连接。
>
> 
>
> 解除连接的方式有两种
>
> 非对称方式：只要任意一方使用DISCONNECT连接就释放，如挂电话
>
> 对称方式：每端只能释放自己方向的连接，只有两端都使用DISCONNECT后连接才完全释放，一方在使用DISCONNECT后不能再发送数据，但还可以接收对方的数据。

> Berkeley套接字（实际传输服务接口）
>
> 套接字（socket）：1983年作为Berkeley UNIX4.2 BSD软件的一部分首次发布。并且很快得到流行，现在以及被广泛的以用于Internet程序设计中。
>
> 
>
> 原语
>
> SOCKET：创建一个新通信端点
>
> BIND：将套接字于本地地址关联
>
> LISTEN：表明愿意接受连接，给出队列长度
>
> ACCEPT：被动创建一个入境连接
>
> CONNECT：主动创建一个连接
>
> SEND：通过连接发送数据
>
> RECEIVE：从连接上接收一些数据
>
> COLSE：释放连接
>
> 
>
> SOCKET和BIND原语
>
> SOCKET用来创建一个新的端点，并在传输实体中用来为它分配表空间，它相当于一个样本。它需要三个参数分别是，**采用的地址格式**、**所需的服务类型**、**所用的传输层协议**。
>
> BIND用来给SOCKET创建的端点绑定IP地址和端口，之所以将BIND和SOCKET分离是为了更灵活的分配端口地址。
>
> 
>
> LISTEN和ACCEPT原语
>
> LISTEN原语和上述简单原语中的LISTEN原语作用相近，表示前期准备完成，可以侦听并接收连接，不同之处在于这里的LISTEN可以一次接受多个连接请求，将他们保存在一个队列中，只要队列没满就可以继续接受连接请求。
>
> ACCEPT原语将处理LISTEN队列中保存的连接请求。ACCEPT以SOCKET为样本创建一个相同的实例副本并返回一个文件描述符。ACCEPT创建的实例是真正的传输实例，用来和另一端进行数据传输服务。

> 套字节编程实例：文件传输服务器（实现从服务器下载指定文件，P389）
>
> 客户端流程（客户端不需要BIND动作，系统随机分配端口，因为一般客户端不用在意端口的使用）
>
> 1、SOCKET：创建传输实体
>
> 2、CONNECT：发起连接
>
> 3、SEND：发送要下载的文件名
>
> 4、RECEIVE：接收服务器发送的文件数据
>
> 5、CLOSE：关闭连接
>
> 
>
> 服务器流程
>
> 1、SOCKET：创建传输实体
>
> 2、BIND：主动设置传输实体的端口号
>
> 3、LISTEN：给出队列长度创建最大接收连接数，并进入侦听状态
>
> 4、ACCEPT：处理到达的连接
>
> 5、RECEIVE：读取客户端要求的文件名
>
> 6、SEND：将文件内容发送给客户端
>
> 7、CLOSE：关闭连接
>
> 
>
> **整个流程中传输实体就像一个文件**，客户端通过把文件名写入传输实体实现数据的发送，服务器通过读取传输实体将客户端发送的消息读出。服务器再将文件内容写入传输实体，客户端再从传输实体中读出文件内容。**整个过程就好像在同一台机器上操作一个共享文件。这就是传输层提供的服务。**

