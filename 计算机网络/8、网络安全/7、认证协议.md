> 简介
>
> ​		什么是认证？认证就是确定通信的对方是所期望的实体，而不是第三方。
>
> ​		区分授权和认证。认证是指确认对方的身份，授权是指对方是否有这一操作的权力。一般通过认证后用户的授权容易通过数据库直接查询得到。
>
> ​		认证与之前介绍的通信安全不同，通信安全目的是为了保证传输过程中的信息安全。
>
> ​		认证是为了保证传输接收端的真实可靠性。

> 基于共享密钥的认证
>
> ​		共享密钥认证：通信双方已经提前共享了一共密钥K，在双方通信之前需要通过一定的认证过程确定对方身份，这个过程一般为**质询-回应**。
>
> ​		**简单的质询回应过程如下：**（前提通信双方已经协商好共享密钥）
>
> ​			1、Alice发送一个随机值请求通信
>
> ​			2、Bob发送一个大数R~B~（大数取值范围很大，难以推测），质询对方是否为Alice
>
> ​			3、Alice用提前协商好的密钥加密R~B~，作为回复，Bob就可以得知对方确实是Alice
>
> ​			4、现在Alice还不知道对方是否为Bob，A发送一个大数R~A~质询对方是否为Bob
>
> ​			5、Bob使用共享密钥加密回复，Alice解密后确认对方为Bob
>
> ![image-20210414120002052](image\image-20210414120002052.png)
>
> ​			仔细观察上述过程可以发现这个协议存在漏洞，协议中一方先完成认证，在确认对方，这样一来对方可能通过前一次的认证来回复认证。过程如下。
>
> ![image-20210414120714677](image\image-20210414120714677.png)
>
> ​	要想设计一个正确的认证协议往往没那么容易，下面有**4条设计认证协议的原则**
>
> ​		1、让发起方先认证自己
>
> ​		2、让发起方和应答方使用不同的密钥作为认证
>
> ​		3、让发起方和应答方从不同集合选择咨询随机数
>
> ​		4、让协议要能够抵抗并行会话攻击
>
> ​	**一个正确的认证协议：**由Bird等在1993年发布，他们证明了完全有可能用系统化的方法构造一个可被证明是正确的协议。协议过程如下
>
> ​		1、Alice发出质询
>
> ​		2、Bob使用HMAC（HMAC在IPSec中最先使用）做散列运行回复质询，同时发送大数质询
>
> ​		3、回复质询
>
> （HMAC数据结构：Alice临时值、Bob临时值、Alice标识、Bob标识、共享密钥，然后使用类似SHA-1函数做散列，由于使用了一个会话中的两个数作为散列，难以通过多开会话得到一对相同的随机值）
>
> ![image-20210414121321410](image\image-20210414121321410.png)
>
> ​		除了上述的HMAC结构外，还可以用密码块链模式顺序的加密所有数据项，使得同一会话之间的关系变得加密，避免其他会话攻击。

> 建立共享密钥：Diffie-Hellman密钥交换
>
> ​		前面介绍了基于公共密钥的认证方法，这里要介绍的是如何交换公共密钥。
>
> ​		在陌生人之间建立共享密钥的协议称为：**Diffie-Hellman密钥交换协议**。这个协议利用了如下的数学特性，在一个非常大的素数为模的情况下，计算离散对数的实用算法目前尚未发现。
>
> ​		协议过程如下：
>
> ​			1、首先Alice或Bob先选取两个大数n、g，n满足是一个素数且(n-1)/2也是一个素数，g也必须满足一些特殊条件。
>
> ​			2、Alice选取一个大数x，给Bob发送消息，消息包含n、g，g^x^ mod n
>
> ​			3、Bob也选取一个大数y，回复g^y^ mod n
>
> ​			4、双方分别计算(g^y^ mod n)^x^ mod n，(g^x^ mod n)^y^ mod n，根据模定理两者的结果肯定为g^xy^ mod n
>
> （这样在不公开密钥的情况下即可得到一个共享密钥，而且第三方就算看到了两个消息，一位不知道x和y也无法计算出密钥）
>
> （要注意的是Diffie-Hellman无法抵抗中间人攻击，P649）
>
> ![image-20210414123157189](image\image-20210414123157189.png)

> 使用密钥分发中心的认证
>
> ​		基于共享密钥的认证的麻烦之处在于用户需要和每一个建立通信的人共享密钥，要与n个人通话就需要建立n个密钥，密钥的管理会成为用户的负担。
>
> ​		这里的另一种方法是使用一个中心结构KDC，来管理共享密钥。**一个简单的KDC认证协议**
>
> ​		Alice要和Bob通信
>
> ​			1、Alice向KDC发送消息，消息中说明自己是Alice，并且使用自己的密钥加密一个会话密钥和要对话的对象
>
> ​			2、KDC收到后根据消息的内容选择对应人的密钥进行解密，然后使用Bob的密钥加密Alice和会话密钥，发送给Bob
>
> ​			3、Bob接收到消息后就知道要和他通信的对象和会话密钥（下图的2箭头画反了）
>
> ![image-20210414125530890](image\image-20210414125530890.png)
>
> ​		上述协议看起来正确，都是它无法抵抗重放攻击。抵抗重放攻击的方法可以参照TCP建立连接的机制，主要有两种方法，1、使用时间戳，2、使用一个临时值，每一方都要保存之前会话中使用过的临时值，以便检查，缺点是要一直保存临时值样本。
>
> ​		**一个正确的KDC协议：由Needham和Schroeder在1987发布**
>
> ​			1、Alice发送一个消息给Bob请求通信，消息中包含Alice标识、Bob标识，公共标识R，Alice密钥加密的消息。
>
> ​			2、Bob收到后根据消息使用自己的密钥加密A、B、R、和一个自己生成的随机数，携带Alice加密的消息发送给KDC
>
> ​			3、KDC收到后用Alice和Bob的密钥解密消息中的密文，验证两个密文中公共标识R是否一致从而判断是否被修改。
>
> ​			4、KDC给Alive和Bob回复一个加密的消息，其中包含会话密钥和各自的随机数，**随机数的目的是防止重放攻击。**
>
> ![image-20210414130526528](image\image-20210414130526528.png)

> 使用Kerberos的身份认证
>
> ​		大多数实际操作系统（如windows）中使用的认证协议是Kerberos，它是Needham-Schroeder协议的一种变化。它的第5版广泛应用于工业界。**设计的目标是运行工作站的用户以一种安全的方式访问网络资源**
>
> ​		**Kerberos有3中服务器**
>
> ​			AS：认证服务器，作用类似于KDC，用户和它之间使用用户私有的密钥
>
> ​			TGS：票据分发服务器，用于产生会话密钥
>
> ​			Bob：Bob居然成为了服务器！！实际上Bob代表普遍意义上的应用服务器
>
> ​		**Kerberos协议交互过程如下**
>
> ​			与AS服务器交互
>
> ​				1、Alice发送消息，携带自己的标识和要通话的TGS服务器标识
>
> ​				2、AS服务器回复两段密文，**一段用Alice密钥加密回复Alice其中包含TGS标识、和TGS交流的会话密钥、时间戳，第二段密文使用TGS密钥加密，用于客户与TGS交互时告知TGS会话密钥**
>
> ​			与TGS服务器交互
>
> ​				3、Alice发送消息，包含要通话的应用服务器标识和会话密钥加密的Alice标识和时间戳，AS服务器回复的第二段密文
>
> ​				4、TGS服务器使用自己的密钥解析第二段密文，获得会话密钥，解密会话密文验证发送方是否为Alice。回复两段密文，**第一段使用会话密钥加密其中包含应用服务器标识，与应用服务器交流的会话密钥，时间戳，第二段密文用于告诉应用服务器会话密钥。**
>
> ​			与应用服务器交互
>
> ​				5、用会话密钥加密其中包含Alice标识，TGS服务器的第二段密文。
>
> ​				6、应用服务器解密获得会话密钥，在解密会话密文判断是否为同一个人，用会话密钥回复确认，认证完成。
>
> ![image-20210414134131566](image\image-20210414134131566.png)

> 使用公开密码学的认证
>
> ​		使用公共密码学完成认证，公共密码学就是那么实用。过程如下
>
> ​			Alice和Bob通信
>
> ​			1、Alice向目录服务器请求Bob证书
>
> ​			2、目录服务器回复证书
>
> ​			3、Alice向Bob发送使用Bob公钥加密的消息，其中包含Alice标识，一个随机数
>
> ​			4、Bob向目录服务器请求Alice证书
>
> ​			5、目录服务器回复证书
>
> ​			6、Bob使用Alice公钥发送消息，其中包含Alice的随机数，B的随机数，会话密钥
>
> ​			7、Alice收到后使用私钥解密，发现有她的随机数就能得知对方一定时Bob（只有Bob的私钥才能解开她的密文），Alice使用会话密钥加密Bob的随机数，Bob收到后也认证了对方时Alice。
>
> ![image-20210414135644438](image\image-20210414135644438.png)