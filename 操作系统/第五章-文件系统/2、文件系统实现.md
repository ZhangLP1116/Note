> 虚拟文件系统：为上层应用程序提供便捷接口，屏蔽下层复杂类型。
>
> 应用程序只需要调用API接口（open、close、read、write等），操作系统就会交给虚拟文件系统处理，才能文件系统在进入对应的文件系统进行处理。
>
> ![image-20210226221812767](image\image-20210226221812767.png)
>
> 目标：屏蔽底层文件系统差异
>
> ![image-20210226222059649](image\image-20210226222059649.png)
>
> 虚拟文件系统实现
>
> 1、维护卷控制块：底层每个文件系统都管理一个卷，管理卷中的所有空间，虚拟文件系统为每个卷分配单独的文件系统。
>
> 2、文件控制块：每个文件都有一个文件控制块，用来标识文件的信息
>
> 3、目录节点：每个目录项一个
>
> ![image-20210226222301219](image\image-20210226222301219.png)
>
> 抽象后的文件系统结构
>
> 一个文件系统由一个卷控制块控制，下面是许多目录控制块，在下面是文件控制块，最底层就是数据块。
>
> ![image-20210226222742088](image\image-20210226222742088.png)
>
> 抽象结构的存储，抽象结构也是需要存储在磁盘的扇区中，对应的数据存储在对应的扇区中
>
> ![image-20210226223021663](image\image-20210226223021663.png)
>
> ![image-20210226223154621](image\image-20210226223154621.png)

> 数据缓存：解决硬盘中数据访问慢问题
>
> ![image-20210226223335376](image\image-20210226223335376.png)
>
> 数据缓存方式
>
> 1、预先读取
>
> 2、使用后缓存
>
> 3、延迟写
>
> 是基于磁盘块大小标志的缓存，还是基于页大小标准的缓存
>
> ![image-20210226223506133](image\image-20210226223506133.png)
>
> 基于页的缓存实现可以更加高效的被应用程序使用
>
> ![image-20210226223832301](image\image-20210226223832301.png)
>
> ![image-20210226223933742](image\image-20210226223933742.png)

> 打开文件的数据结构
>
> 为什么打开文件只有就可以对文件进行读写操作？操作系统在打开文件时做了什么？
>
> 1、打开文件时会读取**文件控制块**中的信息
>
> 2、将这些信息保存在进程的**打开文件表**中
>
> ![image-20210226224309082](image\image-20210226224309082.png)
>
> 进程在打开文件后要对文件进行写操作或者读操作时，硬盘中的文件先别读取到内存中，然后应用程序给出读取的位置，操作系统会查找打开文件表，找到对应的文件控制块，将应用程序要访问的逻辑地址交给文件控制块，文件控制块将逻辑地址转换为物理地址，从硬件中读取数据返回给应用程序。
>
> ![image-20210226224250452](image\image-20210226224250452.png)
>
> 
>
> ![image-20210226224545448](image\image-20210226224545448.png)

> 文件分配：如何给文件分配C盘中的空间，数据结构中有具体算法讲解
>
> 文件的类型
>
> ![image-20210226225035174](image\image-20210226225035174.png)
>
> 根据不同类型进行不同的分配原则：有3这种方法，方法好坏的指标就是高效和访问速度
>
> ![image-20210226225052090](image\image-20210226225052090.png)
>
> 1、连续分配
>
> 每个文件按照地址空间连续方式存储，每个文件存储时只需要指定存储开始位置和长度即可。
>
> 缺点：保存好的文件难以扩展，因为或许空间都被占用，适合只读形式文件存储，如光盘文件
>
> ![image-20210226225230157](image\image-20210226225230157.png)
>
> 2、链式分配
>
> 文件的存储不用连续空间，使用链表结构将不同空间的内容关联起来。
>
> 缺点：不可能进行真正的随机访问，只能串行访问速度较慢。链被破坏后难以修复
>
> ![image-20210226225711470](image\image-20210226225711470.png)
>
> 3、索引存储
>
> ![image-20210226225936593](image\image-20210226225936593.png)
>
> 大文件的索引块实现：多级索引，与内存管理中的思想一样对应大页表的索引可以使用多级页表的方式
>
> ![image-20210226230317830](image\image-20210226230317830.png)
>
> 早期unix系统中就使用多级索引方式分配文件
>
> 从一个文件控制块中保存着多级索引块
>
> ![image-20210226230528961](image\image-20210226230528961.png)
>
> ![image-20210226230703799](image\image-20210226230703799.png)

> 空闲空间列表：文件系统需要对空闲空间进行管理，以用于后续的文件分配
>
> ![image-20210226230805108](image\image-20210226230805108.png)
>
> 使用位图表示空闲空间链表
>
> ![image-20210226230914116](image\image-20210226230914116.png)
>
> 位图一致性保证：位图在开始时被读取到内存中，在使用过程中发生了更改，但是突然断电后没有即使写回硬盘，导致前后位图不一致，就可能发生文件丢失现象。
>
> 解决方法：若要使用空间块时，需要修改磁盘上的位图信息置一，再分配块，再修改内存中的位图信息。
>
> ![image-20210226231253923](image\image-20210226231253923.png)
>
> 其他表示空闲空间列表的方式
>
> ![image-20210226231551412](image\image-20210226231551412.png)